// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_CONNECTION_URL")
}

model User {
  id                  Int                  @id @default(autoincrement())
  email               String               @unique
  password            String
  role                Role                 @default(STUDENT)
  firstName           String               @map("first_name")
  lastName            String               @map("last_name")
  middleName          String               @map("middle_name")
  birthDate           DateTime?            @map("birth_date")
  phone               String?
  canPublish          Boolean              @default(false)
  gender              Gender
  confirmed           Boolean              @default(false)
  avatarLink          String?              @map("avatar_link")
  studentInfo         Student?
  teacherInfo         Teacher?
  articles            Article[]
  courseReviews       CourseReview[]
  olympiadReviews     OlympiadReview[]
  passwordResetTokens PasswordResetToken[]
  registrationTokens  RegistrationToken[]
  articleComments     ArticleComment[]
  articleLikes        ArticleLike[]
  articleDislikes     ArticleDislike[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model PasswordResetToken {
  id        Int         @id @default(autoincrement())
  token     String      @unique
  userId    Int         @map("user_id")
  ip        String
  browser   String
  status    TokenStatus @default(PENDING)
  user      User        @relation(fields: [userId], references: [id])
  expiresIn DateTime    @map("expires_in")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("password_reset_tokens")
}

model RegistrationToken {
  id        Int         @id @default(autoincrement())
  token     String      @unique
  userId    Int         @map("user_id")
  ip        String
  browser   String
  status    TokenStatus @default(PENDING)
  user      User        @relation(fields: [userId], references: [id])
  expiresIn DateTime    @map("expires_in")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("registration_tokens")
}

model Olympiad {
  id                Int                       @id @default(autoincrement())
  name              String
  format            String
  startDate         DateTime
  participationType OlympiadParticipationType
  grade             Int
  rating            Float                     @default(0)
  taskExamples      OlympiadExampleTask[]
  steps             OlympiadStep[]
  reviews           OlympiadReview[]
  rewards           String[]
  applications      OlympiadApplication[]


  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")


  @@map("olympiads")
}

model OlympiadStep {
  id           Int      @id @default(autoincrement())
  name         String
  step         Int
  date         DateTime
  timeDuration Int      @map("time_duration")
  description  String

  olympiadId Int      @map("olympiad_id")
  olympiad   Olympiad @relation(fields: [olympiadId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("olympiad_steps")
}

model Course {
  id             Int                   @id @default(autoincrement())
  name           String
  teacherId      Int                   @map("teacher_id")
  teacher        Teacher               @relation(fields: [teacherId], references: [id])
  capacity       Int
  attendances    CourseAttendance[]
  students       Student[]
  rating         Float                 @default(0)
  grade          Int
  toWhom         String[]              @map("to_whom")
  possibilities  String[]
  steps          CourseEducationStep[]
  reviews        CourseReview[]
  startDate      DateTime              @map("start_date")
  materialsLink  String                @map("materials_link")
  materialsCount Int                   @map("materials_count")
  price          Float
  imageLink      String                @map("image_link")
  eripNumber     String                @map("erip_number")
  finishDate     DateTime              @map("finish_date")
  finished       Boolean               @default(false) @map("finished")
  applications   CourseApplication[]
  modules        CourseModule[]
  tags           CourseTag[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")


  @@map("courses")
}

model CourseModule {
  id          Int    @id @default(autoincrement())
  name        String
  description String
  courseId    Int    @map("course_id")
  course      Course @relation(fields: [courseId], references: [id], onDelete: Cascade)


  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

}

model CourseTag {
  id      Int      @id @default(autoincrement())
  courses Course[]
  name    String   @unique

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("courses_tags")
}

model CourseEducationStep {
  id       Int    @id @default(autoincrement())
  courseId Int    @map("course_id")
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  step     Int
  title    String
  text     String

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("course_education_steps")
}

model CourseApplication {
  id              Int               @id @default(autoincrement())
  courseId        Int               @map("course_id")
  appliciantName  String            @map("appliciant_name")
  appliciantPhone String            @map("appliciant_phone")
  course          Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  studentId       Int?              @map("student_id")
  student         Student?          @relation(fields: [studentId], references: [id])
  status          ApplicationStatus @default(CREATED)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("course_applications")
}


model CourseAttendance {
  id              Int               @id @default(autoincrement())
  courseId        Int               @map("course_id")
  studentId       Int               @map("student_id")
  course          Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student         Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  status          AttendanceStatus
  date            DateTime

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("course_attendances")
}

model OlympiadApplication {
  id         Int               @id @default(autoincrement())
  olympiadId Int               @map("course_id")
  olympiad   Olympiad          @relation(fields: [olympiadId], references: [id], onDelete: Cascade)
  studentId  Int               @map("student_id")
  student    Student           @relation(fields: [studentId], references: [id])
  steps      Int[]
  status     ApplicationStatus @default(CREATED)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("olympiad_applications")
}

model CourseReview {
  id        Int     @id @default(autoincrement())
  courseId  Int     @map("course_id")
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  authorId  Int     @map("author_id")
  rating    Float   @map("rating")
  published Boolean @default(false)
  author    User    @relation(fields: [authorId], references: [id])
  text      String

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("course_reviews")
}

model OlympiadReview {
  id         Int      @id @default(autoincrement())
  olympiadId Int      @map("olympiad_id")
  olympiad   Olympiad @relation(fields: [olympiadId], references: [id], onDelete: Cascade)
  authorId   Int      @map("author_id")
  published  Boolean  @default(false)
  author     User     @relation(fields: [authorId], references: [id])
  rating     Float
  text       String

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("olympiad_reviews")
}

model Student {
  id                     Int                   @id @default(autoincrement())
  userId                 Int                   @unique @map("user_id")
  user                   User                  @relation(fields: [userId], references: [id])
  educationalInstitution String?               @map("educational_institution")
  grade                  Int?
  teachers               String?
  courses                Course[]
  courseApplications     CourseApplication[]
  olympiadApplications   OlympiadApplication[]
  attendances            CourseAttendance[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("students")
}

model Teacher {
  id                  Int      @id @default(autoincrement())
  userId              Int      @unique @map("user_id")
  user                User     @relation(fields: [userId], references: [id])
  courses             Course[]
  rating              Float    @default(0)
  about               String?
  specialisations     String[] @map("specialisation")
  studentsTaughtCount Int      @default(0) @map("students_teached_count")
  telegramLink        String?  @map("telegram_link")
  whatsappLink        String?  @map("whatsapp_link")
  viberLink           String?  @map("viber_link")
  vkLink              String?  @map("vk_link")
  skypeLink           String?  @map("skype_link")


  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("teachers")
}

model Article {
  id       Int              @id @default(autoincrement())
  title    String
  slug     String           @unique
  content  String
  authorId Int              @map("author_id")
  author   User             @relation(fields: [authorId], references: [id])
  tags     ArticleTag[]
  views    Int              @default(0)
  status   ArticleStatus
  comments ArticleComment[]
  likes    ArticleLike[]
  dislikes ArticleDislike[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")


  @@map("articles")
}

model ArticleLike {
  id        Int     @id @default(autoincrement())
  articleId Int     @map("article_id")
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  userId    Int     @map("user_id")
  user      User    @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("article_likes")
}

model ArticleDislike {
  id        Int     @id @default(autoincrement())
  articleId Int     @map("article_id")
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  userId    Int     @map("user_id")
  user      User    @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("article_dislikes")
}

model ArticleComment {
  id        Int      @id @default(autoincrement())
  articleId Int      @map("article_id")
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  authorId  Int      @map("author_id")
  author    User     @relation(fields: [authorId], references: [id])
  text      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("article_comments")
}

model ArticleTag {
  id       Int       @id @default(autoincrement())
  articles Article[]
  name     String    @unique

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("article_tags")
}

model OlympiadExampleTask {
  id     Int      @id @default(autoincrement())
  images String[]

  olympiadId Int      @map("olympiad_id")
  olympiad   Olympiad @relation(fields: [olympiadId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("olympiad_example_tasks")
}

enum Role {
  ADMIN
  STUDENT
  TEACHER
}

enum Gender {
  MALE
  FEMALE
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
}

enum ApplicationStatus {
  CREATED
  FULFILLED
  REJECTED
  PENDING
}

enum OlympiadParticipationType {
  FREE
  PAID
}

enum TokenStatus {
  PENDING
  FULFILLED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  ABSENT_WITH_REASON
}
